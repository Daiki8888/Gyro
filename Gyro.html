<script>
  let lastDirection = '';
  let espBaseUrl = '';

  function sendCommand(direction) {
    if (!espBaseUrl) return;
    if (direction !== lastDirection) {
      lastDirection = direction;
      fetch(`${espBaseUrl}/${direction}`).catch(err => {
        console.error("Send error:", err);
      });
      document.getElementById("dirVal").textContent = direction;
    }
  }

  function handleOrientation(event) {
    const gamma = event.gamma;
    document.getElementById("gammaVal").textContent = gamma.toFixed(1);
    if (gamma > 15) sendCommand("right");
    else if (gamma < -15) sendCommand("left");
    else sendCommand("center");
  }

  document.getElementById("enableOrientation").addEventListener("click", () => {
    const ip = prompt("Enter ESP32 IP address (e.g. 192.168.0.100)");
    if (!ip) return;
    espBaseUrl = `http://${ip}`;
    document.getElementById("status").textContent = `Sending to: ${espBaseUrl}`;

    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission()
        .then(response => {
          if (response === 'granted') {
            window.addEventListener("deviceorientation", handleOrientation);
          } else {
            alert("Permission denied");
          }
        }).catch(console.error);
    } else {
      window.addEventListener("deviceorientation", handleOrientation);
    }
  });
</script>
